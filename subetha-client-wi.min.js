/* SubEtha Window Information v0.0.0-alpha | github.com/bemson | (c) 2015, MIT */
!function(I,C,b,V){function q(){function r(a){for(var g=1,c,b;c=arguments[g];g++)for(b in c)m.call(c,b)&&(a[b]=c[b]);return a}function q(a,g){for(var c=-1,b=a.length;b--;)if(a[b]===g){c=b;break}return c}function J(){var a;"undefined"!==typeof d.hidden?a="hidden":"undefined"!==typeof d.mozHidden?a="mozHidden":"undefined"!==typeof d.msHidden?a="msHidden":"undefined"!==typeof d.webkitHidden&&(a="webkitHidden");return a&&a in d?!d[a]:d.hasFocus()}function D(a){a&&"string"==typeof a||(a=e.url);a&&"string"==
typeof a||(a="public");return 3!=k.state||a!=k.url?(e.url=a,2<k.state&&(y=0),k.open("subetha/wi@"+a),!0):!1}function K(){z||(z=1,A(b,"focus",L),A(b,"blur",M),A(b,"scroll",N),A(b,"resize",O),J()&&(clearInterval(t),t=setInterval(P,100)))}function E(){var a=b.screenX,g=b.screenY;return{x:a,y:g+(b.outerHeight-b.innerHeight),bx:a,by:g}}function Q(){v(r(F(),E()))}function F(){return{width:b.innerWidth,height:b.innerHeight,bwidth:b.outerWidth,bheight:b.outerHeight}}function P(){var a=E();w&&w.x==a.x&&w.y==
a.y||(w=a,v(r(w,F())))}function L(){clearInterval(t);t=setInterval(P,100);v({focus:!0})}function M(){clearInterval(t);v({focus:!1})}function N(){v({scrollx:b.pageXOffset,scrolly:b.pageYOffset})}function O(){clearTimeout(R);Q();R=setTimeout(Q,50)}function S(a){a.id==f.wid&&(e.current=null);e.fire("remove",a)}function v(a){var g={},c=n.deets,b,f,h;for(b in a)!m.call(a,b)||m.call(c,b)&&c[b]==(f=a[b])||(g[b]=c[b]=f,h=1);h&&(G(g),H(function(){e.fire("update",c,g)}))}function G(a,b){k._transmit("subetha/winfo",
b,{id:x,cnt:f.cnt,deets:a})}var u=C||I?require("subetha"):b.Subetha,k=new u.Client,m=Object.prototype.hasOwnProperty,f,z,t,R,n,x,w,T,y=1,d=b.document,U,p,e=[],h={},A=b.attachEvent?function(a,b,c){a.attachEvent("on"+b,c)}:function(a,b,c){a.addEventListener(b,c,!1)},B=b.attachEvent?function(a,b,c){a.detachEvent("on"+b,c)}:function(a,b,c){a.removeEventListener(b,c,!1)},H="function"===typeof setImmediate&&setImmediate||C&&process.nextTick||function(a){setTimeout(a,0)};r(e,u.EventEmitter.prototype,{stop:function(){y=
0;k.close()},start:D,current:null,url:"public"});u.winfos=e;b==self?(e.unsupported=0,k.on("::connect",function(){var a=this.url;U||(U=d.body,p=d.head);m.call(p,"_wi")||(p._wi={});m.call(p._wi,a)||(T=a,p._wi[a]={wid:u.guid(),mid:this.id,cnt:0});f=p._wi[a];f.cnt++;x=f.wid;f.mid==k.id&&(n=h[x]={id:x,cnt:f.cnt,deets:r({focus:J(),id:x},E(),F(),{scrollx:b.pageXOffset,scrolly:b.pageYOffset})},e.current=e[0]=n.deets,K(),H(function(){var a=r({current:!0},n.deets);e.fire("add",a)}),setTimeout(function(){G(n.deets)},
5))}).on("::disconnect",function(){var a=p._wi,g,c;f.cnt--;f.mid==k.id&&z&&(z=0,B(b,"focus",L),B(b,"blur",M),B(b,"scroll",N),B(b,"resize",O),clearInterval(t));if(!f.cnt){if(a){delete a[T];for(g in a)if(m.call(a,g)){c=1;break}c||delete p._wi}a=e;g=q(a,n.deets);~g&&a.splice(g,1);y&&H(D);y=1;for(var l in h)m.call(h,l)&&(a=h[l],S(a.deets));h={};e.length=0}f=0}).on("::join",function(a,b){b||G(n.deets,a)}).on("::drop",function(a){var b=a.wid,c;if(b&&m.call(h,b))if(c=h[b],c.cnt--,f.mid==a.id)f.mid=this.id,
n=c,n.cnt=f.cnt,K();else if(!c.cnt){a=e;var l=q(a,c.deets);~l&&a.splice(l,1);delete h[b];S(c.deets)}}),u.msgType["subetha/winfo"]=function(a,b,c){var l,d,k;c&&"object"==typeof c&&"number"==typeof c.cnt&&"string"==typeof(d=c.id)&&"object"==typeof(l=c.deets)&&l&&(m.call(h,d)?a=h[d]:(a=h[d]={id:d,deets:{id:d,current:d==f.wid}},e.push(a.deets),b.wid=d,k=1),r(a.deets,l),a.cnt=c.cnt,k?e.fire("add",a.deets):e.fire("update",a.deets,l))},D()):e.unsupported=1;return u}I?define(q):C?module.exports=q():b.Subetha&&
!b.Subetha.winfos&&q()}("function"===typeof define,"undefined"!=typeof exports,this);